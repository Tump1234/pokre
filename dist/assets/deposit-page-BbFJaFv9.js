import{j as e,p as s,q as t,r as a,t as n,v as d,u as o,G as i,f as r}from"./index-CvTZHx2e.js";import{r as l}from"./redux-vendor-nVRhWwEL.js";import{c,F as m,d as u,e as p,f as h,g as x}from"./index-CmRPyfVs.js";import{y as j}from"./ui-vendor-BXfdezGw.js";import"./react-vendor-B_uAldPx.js";function v({deposits:s,onAccept:t,onIgnore:a,showHistory:n=!1}){const[d,o]=l.useState(1),[i,r]=l.useState(15),u=e=>{o(e)},p=s.slice((d-1)*i,d*i),h=Math.ceil(s.length/i);return e.jsxs("div",{className:"admin-table-wrapper",children:[e.jsxs("table",{className:"admin-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"№"}),e.jsx("th",{children:"Хэрэглэгч"}),e.jsx("th",{children:"Дүн"}),e.jsx("th",{children:"Үүсгэсэн огноо"}),n&&e.jsx("th",{children:"Зөвшөөрсөн огноо"}),e.jsx("th",{children:n?"Төлөв":"Үйлдэл"})]})}),e.jsx("tbody",{children:p.map((s,o)=>{var r;const l=new Date(s.createDate),u={month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"},p="PENDING"===s.status||!s.status&&!s.approvedBy&&!s.approveDate&&!s.adminId&&!s.approvedDate,h="APPROVED"===s.status||s.adminId&&s.approvedDate||s.approvedBy&&s.approveDate,x="DENIED"===s.status;let j="Хүлээгдэж буй",v="status-pending";h?(j="Зөвшөөрөгдсөн",v="status-approved"):x&&(j="Татгалзсан",v="status-denied");const f=s.approvedDate?new Date(s.approvedDate):s.approveDate?new Date(s.approveDate):null;return e.jsxs("tr",{className:p?"row-pending":h?"row-approved":"row-denied",children:[e.jsx("td",{className:"table-index",children:(d-1)*i+o+1}),e.jsx("td",{className:"table-user",children:null==(r=s.user)?void 0:r.username}),e.jsx("td",{className:"table-amount",children:s.amount.toLocaleString("mn-MN")}),e.jsx("td",{className:"table-date",children:l.toLocaleString("mn-MN",u)}),n&&e.jsx("td",{className:"table-date",children:f?f.toLocaleString("mn-MN",u):"-"}),e.jsx("td",{className:"table-actions",children:!n&&p?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-accept",title:"Зөвшөөрөх",onClick:()=>null==t?void 0:t(s.depositId),children:e.jsx(c,{size:18})}),e.jsx("button",{className:"btn-icon btn-ignore",title:"Татгалзах",onClick:()=>null==a?void 0:a(s.depositId),children:e.jsx(m,{size:18})})]}):e.jsx("span",{className:v,children:j})})]},s.depositId)})})]}),e.jsxs("div",{className:"pagination-controls",children:[e.jsxs("span",{children:["Page ",d," of ",h]}),e.jsx("button",{onClick:()=>u(Math.max(1,d-1)),disabled:1===d,children:"Өмнөх"}),e.jsx("button",{onClick:()=>u(Math.min(h,d+1)),disabled:d===h,children:"Дараагийнх"}),e.jsxs("label",{children:["Items per page:",e.jsx("select",{className:"custom-select",value:i,onChange:e=>{r(Number(e.target.value)),o(1)},children:[10,20,50,100].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("span",{children:["Нийт: ",s.length]})]})]})}function f({isOpen:s,onClose:t,onConfirm:a,title:n,message:d,confirmText:o="Тийм",cancelText:i="Үгүй",type:r="warning"}){if(l.useEffect(()=>{const e=e=>{"Escape"===e.key&&t()};return s&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow="unset"}},[s,t]),!s)return null;return e.jsx("div",{className:"confirm-modal-overlay",onClick:t,children:e.jsxs("div",{className:`confirm-modal confirm-modal-${r}`,onClick:e=>e.stopPropagation(),children:[e.jsx("div",{className:"confirm-modal-header",children:e.jsx("h3",{className:"confirm-modal-title",children:n})}),e.jsx("div",{className:"confirm-modal-body",children:e.jsx("p",{className:"confirm-modal-message",children:d})}),e.jsxs("div",{className:"confirm-modal-footer",children:[e.jsx("button",{className:"confirm-modal-btn confirm-modal-btn-cancel",onClick:t,children:i}),e.jsx("button",{className:`confirm-modal-btn confirm-modal-btn-confirm confirm-modal-btn-${r}`,onClick:()=>{a(),t()},children:o})]})]})})}function N(){var c,N;const{data:b}=s(void 0,{refetchOnMountOrArgChange:!0,refetchOnFocus:!0}),{data:g}=t(),[I,{isSuccess:y,isError:w,error:C}]=a(),[D]=n(),[E]=d(),S=localStorage.getItem("accessToken"),{refetch:k}=o(void 0,{skip:!S}),{adminNotifications:O,resetAdminNotifications:A,ws:T}=l.useContext(i),[L,P]=l.useState(!1),[z,M]=l.useState({userId:"",amount:"",type:"BANK_TRANSFER"}),[F,R]=l.useState({}),[B,_]=l.useState(null),[q,$]=l.useState(""),[G,V]=l.useState(!1),[H,K]=l.useState("pending"),U=l.useRef(null),[J,Q]=l.useState({isOpen:!1,depositId:null});l.useEffect(()=>{y&&(k(),P(!1),_("Deposit created successfully"),M({userId:"",amount:"",type:"BANK_TRANSFER"}),R({}),$(""))},[y,k]),l.useEffect(()=>{var e;if(w&&C){const s=null==(e=null==C?void 0:C.data)?void 0:e.errorMessage;_("Error: "+s)}},[w,C]),l.useEffect(()=>{function e(e){U.current&&!U.current.contains(e.target)&&V(!1)}return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const W=(null==g?void 0:g.filter(e=>{const s=q.toLowerCase(),t=e.username.toLowerCase().includes(s),a=e.userId.toString().includes(q);return t||a}))??[];function X(e){e.preventDefault(),function(){const e={};return z.userId||(e.userId="Хэрэглэгчийг сонгоно уу"),(!z.amount||Number(z.amount)<=0)&&(e.amount="Хэмжээг зөв оруулна уу"),R(e),0===Object.keys(e).length}()&&I({userId:Number(z.userId),amount:Number(z.amount),type:z.type,details:{}})}const Y=(null==(c=null==g?void 0:g.find(e=>e.userId===Number(z.userId)))?void 0:c.username)||q,Z=(null==b?void 0:b.filter(e=>"PENDING"===e.status||!e.status&&!e.approvedBy&&!e.approveDate))??[],ee=(null==b?void 0:b.filter(e=>"APPROVED"===e.status||"DENIED"===e.status||e.approvedBy||e.approveDate))??[],se=Z.length;return l.useEffect(()=>{O>0&&A()},[O,A]),l.useEffect(()=>{if(!T)return;const e=e=>{try{const s=JSON.parse(e.data);"ADMIN_DEPOSIT_NOTIFICATION"===s.type&&(r.log("New deposit notification received",s.data),j.info("Шинэ орлогын хүсэлт ирлээ!",{position:"top-right",autoClose:3e3})),"DEPOSIT_STATUS_UPDATE"===s.type&&r.log("Deposit status updated")}catch(s){}};return T.addEventListener("message",e),()=>{T.removeEventListener("message",e)}},[T]),e.jsxs("div",{className:"deposit-page-wrapper",children:[B&&e.jsx("div",{className:"admin-message",children:B}),e.jsxs("div",{className:"create-button-container",children:[e.jsxs("button",{className:"add-deposit-button",onClick:()=>P(!0),title:"Шинэ орлого нэмэх",children:[e.jsx(u,{size:20}),e.jsx("span",{children:"Орлого нэмэх"})]}),se>0&&e.jsxs("div",{className:"pending-notification",children:[e.jsx("span",{className:"notification-badge",children:se}),e.jsx("span",{children:"Хүлээгдэж буй орлого"})]})]}),e.jsxs("div",{className:"deposit-tabs",children:[e.jsxs("button",{className:"deposit-tab "+("pending"===H?"active":""),onClick:()=>K("pending"),children:["Хүлээгдэж буй (",se,")"]}),e.jsxs("button",{className:"deposit-tab "+("history"===H?"active":""),onClick:()=>K("history"),children:["Түүх (",ee.length,")"]})]}),"pending"===H?e.jsx(v,{deposits:Z,onAccept:async e=>{try{await D({id:e}).unwrap(),j.success("Орлого амжилттай зөвшөөрөгдлөө!")}catch(s){j.error("Орлого зөвшөөрөхөд алдаа гарлаа!")}},onIgnore:e=>{var s;const t=null==b?void 0:b.find(s=>s.depositId===e);Q({isOpen:!0,depositId:e,amount:null==t?void 0:t.amount,username:null==(s=null==t?void 0:t.user)?void 0:s.username})}}):e.jsx(v,{deposits:ee,showHistory:!0}),L&&e.jsx("div",{className:"add-deposit-modal-overlay",onClick:()=>P(!1),children:e.jsxs("div",{className:"add-deposit-modal",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"add-deposit-modal-header",children:[e.jsxs("h2",{className:"add-deposit-modal-title",children:[e.jsx(p,{size:24}),"Орлого нэмэх"]}),e.jsx("button",{className:"add-deposit-modal-close",onClick:()=>P(!1),type:"button",children:e.jsx(m,{size:24})})]}),e.jsx("div",{className:"add-deposit-modal-body",children:e.jsxs("form",{className:"add-deposit-form",onSubmit:X,noValidate:!0,children:[e.jsxs("div",{className:"add-deposit-form-group",children:[e.jsxs("label",{className:"add-deposit-form-label",children:[e.jsx(h,{size:16}),"Хэрэглэгч",e.jsx("span",{className:"add-deposit-form-label-required",children:"*"})]}),e.jsxs("div",{className:"add-deposit-user-search",ref:U,children:[e.jsx("input",{type:"text",className:"add-deposit-form-input",placeholder:"Нэр эсвэл ID-аар хайх...",value:Y,onChange:e=>{$(e.target.value),V(!0),M(e=>({...e,userId:""}))},onFocus:()=>V(!0),autoComplete:"off"}),G&&e.jsx("ul",{className:"add-deposit-user-dropdown",children:W.length>0?W.map(s=>e.jsx("li",{onClick:()=>{M(e=>({...e,userId:String(s.userId)})),$(s.username),V(!1),R(e=>({...e,userId:""}))},className:"add-deposit-user-dropdown-item",children:e.jsxs("div",{className:"user-dropdown-item-content",children:[e.jsx("span",{className:"user-dropdown-name",children:s.username}),e.jsxs("span",{className:"user-dropdown-id",children:["ID: ",s.userId]})]})},s.userId)):e.jsx("li",{className:"add-deposit-user-dropdown-no-results",children:"Хэрэглэгч олдсонгүй"})})]}),F.userId&&e.jsxs("div",{className:"add-deposit-form-error",children:[e.jsx(x,{size:14}),F.userId]})]}),e.jsxs("div",{className:"add-deposit-form-group",children:[e.jsxs("label",{className:"add-deposit-form-label",children:[e.jsx(p,{size:16}),"Дүн",e.jsx("span",{className:"add-deposit-form-label-required",children:"*"})]}),e.jsx("input",{type:"number",name:"amount",className:"add-deposit-form-input",placeholder:"Жишээ: 50,000",min:1,value:z.amount,onChange:function(e){const{name:s,value:t}=e.target;M(e=>({...e,[s]:t})),R(e=>({...e,[s]:""}))},required:!0}),F.amount&&e.jsxs("div",{className:"add-deposit-form-error",children:[e.jsx(x,{size:14}),F.amount]})]})]})}),e.jsxs("div",{className:"add-deposit-modal-footer",children:[e.jsx("button",{type:"button",className:"add-deposit-btn add-deposit-btn-cancel",onClick:()=>P(!1),children:"Болих"}),e.jsxs("button",{type:"submit",className:"add-deposit-btn add-deposit-btn-submit",onClick:X,children:[e.jsx(p,{size:18}),"Хадгалах"]})]})]})}),e.jsx(f,{isOpen:J.isOpen,onClose:()=>Q({isOpen:!1,depositId:null}),onConfirm:async()=>{if(J.depositId)try{await E({id:J.depositId}).unwrap(),j.success("Орлого татгалзагдлаа!")}catch(e){j.error("Орлого татгалзахад алдаа гарлаа!")}},title:"Орлого татгалзах",message:`Та "${J.username}" хэрэглэгчийн ${null==(N=J.amount)?void 0:N.toLocaleString("mn-MN")}₮ дүнтэй орлогыг татгалзахдаа итгэлтэй байна уу?`,confirmText:"Татгалзах",cancelText:"Болих",type:"danger"})]})}export{N as default};
