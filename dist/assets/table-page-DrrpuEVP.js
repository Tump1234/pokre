const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/texas-table-game-wTMeuWpu.js","assets/index-CvTZHx2e.js","assets/redux-vendor-nVRhWwEL.js","assets/react-vendor-B_uAldPx.js","assets/index-BtLCnAg-.css","assets/router-vendor-BW0mZDy4.js","assets/6820-t6wN11A0.js","assets/formatNumber-BK7Si0DQ.js","assets/seatOffsets-BfPDEa1f.js"])))=>i.map(i=>d[i]);
import{e,f as t,j as n,g as r,_ as a}from"./index-CvTZHx2e.js";import{b as s}from"./router-vendor-BW0mZDy4.js";import{r as l}from"./redux-vendor-nVRhWwEL.js";import{f as u}from"./formatNumber-BK7Si0DQ.js";const c="https://www.zeus-poker.net".replace(/^http/,"ws")+"/ws/table";function o(e,t){var n,r,a,s;switch(t.type){case"RESET_GAME":return{...e,seats:e.seats.map(e=>({...e,holeCards:[],isAllIn:!1,isFolded:!1,isWinner:!1,winnings:0,netResult:0,lastActionText:""})),communityCards:[],currentPot:0,currentBets:{},pots:[],combinedSplitPot:void 0,turnPlayer:null,currentPlayerSeat:0,state:"WAITING_FOR_PLAYERS"};case"GAME_STATE_UPDATE":{const{state:r,currentPot:a,currentBets:s,communityCards:l,pots:u}=t.payload;if("WAITING_FOR_PLAYERS"===r)return o(e,{type:"RESET_GAME"});const c="PRE_FLOP"===r,i=l&&l.length!==((null==(n=e.communityCards)?void 0:n.length)||0)||c;return{...e,currentPot:a,currentBets:s||{},communityCards:l||[],state:r,pots:u||[],combinedSplitPot:c?void 0:e.combinedSplitPot,seats:i?e.seats.map(e=>({...e,lastActionText:""})):e.seats}}case"UPDATE_TABLE":{const{table:n,session:r}=t,a=r||{holeCards:e.seats.reduce((e,t)=>(t.user&&(e[t.seatId]=t.holeCards||[]),e),{}),currentBets:e.currentBets||{},currentPot:e.currentPot||0},s=function(e,t,n={}){return Array.from({length:t},(t,r)=>{var a;const s=e[r.toString()]||null,l=(n[r.toString()]||[]).map(e=>({...e}));return s?{user:s.user||null,seatId:s.seatId??r,stack:s.stack||0,holeCards:l,isAllIn:s.isAllIn||!1,isFolded:s.isFolded||!1,winnings:s.winnings||0,netResult:s.netResult||0,username:(null==(a=s.user)?void 0:a.username)??"Empty",isDisconnected:s.disconnected||!1,isTimeoutActed:s.timeoutActed||!1,isSittingOut:s.isSittingOut||!1}:{user:null,seatId:r,stack:0,holeCards:l,isAllIn:!1,isFolded:!1,winnings:0,netResult:0,username:"Empty",isDisconnected:!1,isTimeoutActed:!1,isSittingOut:!1}})}(n.seats,n.maxPlayers,a.holeCards),l=s.map((t,n)=>{const r=e.seats[n];return r&&r.lastActionText&&t.user?{...t,lastActionText:r.lastActionText}:t}),u=(null==r?void 0:r.state)||e.state,c=("SHOWDOWN"===u||"FINISHED"===u)&&0===(null==r?void 0:r.currentPot)&&e.currentPot>0;return{...e,tablestate:n,seats:l,dealerSeatIndex:(null==r?void 0:r.dealerSeatIndex)??e.dealerSeatIndex,smallBlindSeatIndex:(null==r?void 0:r.smallBlindSeatIndex)??e.smallBlindSeatIndex,bigBlindSeatIndex:(null==r?void 0:r.bigBlindSeatIndex)??e.bigBlindSeatIndex,smallBlind:n.smallBlind||0,bigBlind:n.bigBlind||0,maxBuyIn:n.maxBuyIn||0,minBuyIn:n.minBuyIn||0,maxPlayers:n.maxPlayers||8,turnPlayer:(null==r?void 0:r.turnPlayer)??e.turnPlayer,currentBets:(null==r?void 0:r.currentBets)||e.currentBets,currentPot:c?e.currentPot:(null==r?void 0:r.currentPot)||e.currentPot,currentPlayerSeat:(null==r?void 0:r.currentPlayerSeat)??e.currentPlayerSeat,state:u,communityCards:(null==r?void 0:r.communityCards)??e.communityCards,turnStartTime:(null==r?void 0:r.turnStartTime)??e.turnStartTime}}case"PLAYER_ACTION":{const{actionType:n,seatId:s,amount:l=0,updatedStack:c,cards:o=[],currentPot:i,currentBets:d,actionId:m,optimistic:S}=t.data;if(m&&(null==(r=e.lastActions)?void 0:r[m]))return e;const A=e.seats[s];if(!A)return e;const y=u(l),I="FOLD"===n?"Fold":"CALL"===n?`Call ${y}`:"RAISE"===n?`Raise ${y}`:"ALL_IN"===n?"All-in":"CHECK"===n?"Check":"REVEAL_CARDS"===n?"Reveal":"",p=c??(A.stack??0)-(S?0:l),T=l>=p+l,E="FOLD"===n,b=o.length>0?o.map(e=>({...e})):A.holeCards??[],C=A.isFolded!==(A.isFolded||E)||A.isAllIn!==(T||"ALL_IN"===n)||A.stack!==p||A.lastActionText!==I||b.length!==((null==(a=A.holeCards)?void 0:a.length)??0);if(!(C||i||d||m))return e;const P=C?e.seats.map((e,t)=>t===s?{...A,isFolded:A.isFolded||E,isAllIn:T||"ALL_IN"===n,stack:p,holeCards:b,lastActionText:I}:e):e.seats,g=("SHOWDOWN"===e.state||"FINISHED"===e.state)&&0===i&&e.currentPot>0;return{...e,seats:P,currentPot:g?e.currentPot:i??e.currentPot,currentBets:d??e.currentBets,lastActions:{...e.lastActions,...m?{[m]:"applied"}:{}}}}case"TURN_UPDATE":{const{currentPlayerSeat:n,isAuto:r,turnStartTime:a}=t.data;return{...e,currentPlayerSeat:n??e.currentPlayerSeat,turnPlayer:(null==(s=e.seats[n])?void 0:s.user)||null,isAuto:r??!1,turnStartTime:a??e.turnStartTime}}case"COMBINED_SPLIT_POT":{const{hands:n,sidePots:r,stacks:a,communityCards:s}=t.data;let l=!1;const u=e.seats.map((e,t)=>{const r=null==n?void 0:n[t];if(!r)return e;const s=void 0!==(null==a?void 0:a[t])&&a[t]!==e.stack,u=void 0!==r.isWinner&&r.isWinner!==e.isWinner,c=void 0!==r.netResult&&r.netResult!==e.netResult,o=void 0!==r.winnings&&r.winnings!==e.winnings;if(!(s||u||c||o))return e;l=!0;const i=r.holeCards?r.holeCards.map(e=>({...e})):e.holeCards;return{...e,stack:(null==a?void 0:a[t])??e.stack,isWinner:r.isWinner??e.isWinner,netResult:r.netResult??e.netResult,winnings:r.winnings??e.winnings,holeCards:i}});return{...e,combinedSplitPot:{hands:n,sidePots:r,stacks:a,communityCards:s},seats:l?u:e.seats}}case"AUTH":return{...e,isAuthenticated:!0,usableBalance:t.data.balance??0,currentUser:t.data.user};case"HOLE_CARDS_UPDATE":{const n=t.payload;let r=!1;const a=e.seats.map((e,t)=>{const a=n[t];if(!a)return e;r=!0;const s=a.map(e=>({...e}));return{...e,holeCards:s}});return r?{...e,seats:a}:e}default:return e}}const i=l.createContext(null),d=({tableId:r,children:a})=>{const s=function(n=""){const[r,a]=l.useReducer(o,{minBuyIn:0,maxBuyIn:0,smallBlind:0,bigBlind:0,maxPlayers:8,dealerSeatIndex:0,smallBlindSeatIndex:0,bigBlindSeatIndex:0,usableBalance:0,isAuthenticated:!1,turnPlayer:null,isFolded:!1,isAllIn:!1,isAuto:!1,currentBets:{},currentPot:0,seats:[],pots:[],currentPlayerSeat:0,communityCards:[],state:"WAITING_FOR_PLAYERS",lastActions:{},callAmounts:{},revealedHoleCards:{}}),[s,u]=l.useState([]),i=l.useRef([]),d=l.useRef(null),m=l.useRef([]),S=l.useRef(null),A=l.useRef([]),[y,I]=l.useState(!1),[p,T]=l.useState(n),[E,b]=l.useState([]),C=l.useRef(null),P=l.useRef(!1),g=l.useRef(!0),h=l.useRef(0),v=l.useRef(null),f=l.useRef(""),B=l.useRef(null),R=parseInt(n||"0"),{data:k}=e(R,{skip:!R});l.useEffect(()=>{f.current=p},[p]),l.useEffect(()=>{if(k){const e=k.seats??{},t=k.maxPlayers??8;a({type:"UPDATE_TABLE",table:{...k,seats:e,maxPlayers:t,isFolded:!1,minBuyIn:k.minBuyIn??0,maxBuyIn:k.maxBuyIn??0,smallBlind:k.smallBlind??0,bigBlind:k.bigBlind??0},session:{communityCards:[],currentBets:{},currentPot:0}})}},[k]);const x=l.useCallback(e=>{const t={id:Math.random(),username:(null==e?void 0:e.username)||"Unknown",message:(null==e?void 0:e.content)||""};i.current.push(t),C.current||(C.current=setTimeout(()=>{u([...i.current]),C.current=null},100)),"SUBSCRIBE"===(null==e?void 0:e.action)&&_("TABLE",{tableId:parseInt(p||"0"),action:"SUBSCRIBE"})},[p]),_=l.useCallback((e,n)=>{var r;if((null==(r=d.current)?void 0:r.readyState)===WebSocket.OPEN)try{d.current.send(JSON.stringify({type:e,data:n})),t.log(`[WS] Sent message: ${e}`,n)}catch(a){A.current.push({type:e,data:n})}else A.current.push({type:e,data:n})},[]),N=l.useCallback(()=>{var e,n;B.current&&(clearTimeout(B.current),B.current=null);const r=localStorage.getItem("accessToken");if(r)if((null==(e=d.current)?void 0:e.readyState)===WebSocket.OPEN)try{d.current.send(JSON.stringify({type:"AUTH",data:{accessToken:r}})),t.log("[WS] Authentication sent")}catch(a){}else(null==(n=d.current)?void 0:n.readyState)===WebSocket.CONNECTING&&(B.current=setTimeout(N,100))},[]),O=l.useCallback(e=>{var n,r,s,l,u,c,o,i,d,m;try{switch(e.type){case"AUTH":t.log("[WS] Authenticated successfully"),a({type:"AUTH",data:{balance:(null==(n=e.data)?void 0:n.balance)??0,user:null==(r=e.data)?void 0:r.user,isAuthenticated:!0}}),h.current=0,p&&_("TABLE",{tableId:parseInt(p),action:"SUBSCRIBE"});break;case"TABLE":a({type:"UPDATE_TABLE",table:null==(s=e.data)?void 0:s.table,session:null==(l=e.data)?void 0:l.session}),(null==(c=null==(u=e.data)?void 0:u.session)?void 0:c.destinedCommunityCards)&&b(e.data.session.destinedCommunityCards.map(e=>({suit:e.suit,rank:e.rank,secret:!1})));break;case"CHAT":x(e.data);break;case"GAME":switch(null==(o=e.data)?void 0:o.action){case"PLAYER_ACTION_WITH_STATE":a({type:"PLAYER_ACTION",data:{...e.data.playerAction,currentPot:null==(i=e.data.tableUpdate.session)?void 0:i.currentPot,currentBets:null==(d=e.data.tableUpdate.session)?void 0:d.currentBets}});break;case"PLAYER_ACTION":a({type:"PLAYER_ACTION",data:e.data});break;case"TURN_UPDATE":a({type:"TURN_UPDATE",data:e.data});break;case"COMBINED_SPLIT_POT":a({type:"COMBINED_SPLIT_POT",data:e.data});break;case"HOLE_CARDS":a({type:"HOLE_CARDS_UPDATE",payload:e.data});break;default:a({type:"GAME_STATE_UPDATE",payload:e.data})}break;case"ERROR":localStorage.getItem("accessToken")&&t.error("[WS] Server error:",null==(m=e.data)?void 0:m.error)}}catch(S){}},[x,_,p]),W=l.useCallback(()=>{var e,n;if(!P.current&&(null==(e=d.current)?void 0:e.readyState)!==WebSocket.OPEN&&(null==(n=d.current)?void 0:n.readyState)!==WebSocket.CONNECTING&&!(h.current>=10)&&g.current)try{if(P.current=!0,t.log(`[WS] Attempting to connect (attempt ${h.current+1}/10)`),d.current){const e=d.current.readyState;if(e===WebSocket.OPEN||e===WebSocket.CLOSING)try{d.current.close()}catch(r){t.warn("[WS] Error closing existing connection:",r)}d.current=null}d.current=new WebSocket(c),d.current.onopen=()=>{t.log("[WS] Connection established"),P.current=!1,I(!0),h.current=0,N(),A.current.length>0&&(t.log(`[WS] Sending ${A.current.length} queued messages`),A.current.forEach(e=>{var n;try{null==(n=d.current)||n.send(JSON.stringify(e))}catch(r){t.error("[WS] Failed to send queued message:",r)}}),A.current=[])},d.current.onmessage=e=>{try{const t=JSON.parse(e.data);if(m.current.push(t),S.current)return;S.current=setTimeout(()=>{S.current=null;const e=m.current;m.current=[],"requestIdleCallback"in window&&e.length>5?requestIdleCallback(()=>{e.forEach(O)},{timeout:100}):e.forEach(O)},50)}catch(n){t.error("[WS] Error parsing message:",n)}},d.current.onerror=e=>{t.error("[WS] WebSocket error:",e),P.current=!1},d.current.onclose=e=>{if(t.log(`[WS] Connection closed (code: ${e.code}, reason: ${e.reason})`),P.current=!1,I(!1),!g.current)return void t.log("[WS] Not reconnecting (intentional close)");if(h.current>=10)return void t.error("[WS] Max reconnection attempts reached");const n=Math.min(1e3*Math.pow(2,h.current),3e4);h.current++,v.current&&clearTimeout(v.current),t.log(`[WS] Reconnecting in ${n}ms (attempt ${h.current})`),v.current=setTimeout(()=>{v.current=null,W()},n)}}catch(a){P.current=!1}},[N,O]);l.useEffect(()=>(p&&(g.current=!0,W()),()=>{if(g.current=!1,P.current=!1,v.current&&(clearTimeout(v.current),v.current=null),S.current&&(clearTimeout(S.current),S.current=null),C.current&&(clearTimeout(C.current),C.current=null),B.current&&(clearTimeout(B.current),B.current=null),d.current){const t=d.current.readyState,n=d.current;d.current.onopen=null,d.current.onclose=null,d.current.onerror=null,d.current.onmessage=null,d.current=null;try{t===WebSocket.CONNECTING?setTimeout(()=>{n.readyState===WebSocket.OPEN&&n.close(1e3,"Component unmounting")},10):t===WebSocket.OPEN&&n.close(1e3,"Component unmounting")}catch(e){}}}),[p,W]);const L=l.useCallback((e,t,n=!1,r)=>_("TABLE",{tableId:parseInt(p||"0"),action:"TAKE_SEAT",seatIndex:e,amount:t,isBot:n,botName:r}),[_,p]),w=l.useCallback(e=>_("TABLE",{tableId:parseInt(p||"0"),action:"RECHARGE",amount:e}),[_,p]),D=l.useCallback(e=>_("TABLE",{tableId:parseInt(p||"0"),action:"LEAVE_SEAT",seatIndex:e}),[_,p]),j=l.useCallback((e,t)=>{const n=Math.random().toString(36).substring(2,12);a({type:"PLAYER_ACTION",data:{actionType:e,seatId:r.currentPlayerSeat,amount:t||0,actionId:n,optimistic:!0}}),_("GAME",{tableId:parseInt(p||"0"),action:e,amount:t,actionId:n})},[_,p,r.currentPlayerSeat]),U=l.useCallback(e=>_("CHAT",{tableId:parseInt(p||"0"),message:e}),[_,p]),F=l.useCallback(()=>_("TABLE",{tableId:parseInt(p||"0"),action:"RECONNECT"}),[_,p]),G=r.isAuthenticated;return{gameState:r,chats:s,ws:d,socketReady:y,tableId:p,setTableId:T,destinedCommunityCards:E,takeSeat:L,leaveSeat:D,sendGameAction:j,sendChat:U,rejoinTable:F,recharge:w,isReady:G}}(r);return n.jsx(i.Provider,{value:s,children:a})},m=()=>{const e=l.useContext(i);if(!e)throw new Error("useGame must be used within GameProvider");return e};function S({message:e}){return n.jsxs("div",{className:"loading-container",children:[n.jsx("div",{className:"spinner"}),e&&n.jsx("p",{children:e})]})}const A=l.lazy(()=>a(()=>import("./texas-table-game-wTMeuWpu.js").then(e=>e.t),__vite__mapDeps([0,1,2,3,4,5,6,7,8])));function y(){const{isReady:e,socketReady:t}=m();return n.jsxs(n.Fragment,{children:[e?n.jsx(l.Suspense,{fallback:n.jsx(S,{message:""}),children:n.jsx(A,{})}):n.jsx(S,{message:""}),!t&&n.jsx("div",{className:"modal-overlay",children:n.jsx("p",{className:"connection-message",children:"Холболт салсан. Дахин холбогдож байна..."})})]})}const I=Object.freeze(Object.defineProperty({__proto__:null,default:function(){var e;const t=null==(e=s().state)?void 0:e.table;if(!t)return n.jsx("p",{children:"Table data missing. Navigate from homepage."});const a=t.tableId;return n.jsx("div",{className:"table-page",children:n.jsx(r,{children:n.jsx(d,{tableId:a,children:n.jsx(y,{})})})})}},Symbol.toStringTag,{value:"Module"}));export{I as t,m as u};
